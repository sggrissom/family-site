{{ define "title" }}add post{{ end }}
{{ define "content" }}
<form method="post" action="/posts/add" id="add-post-form">
    <label>Person:
        <select name="personId">
            {{ range .People }}
            <option value="{{ .Id }}">{{ .Name }}</option>
            {{ end }}
        </select>
    </label>
    <label>Entry Date: <input type="date" name="entryDate" value="{{ .Post.EntryDate | formatDateForInput }}"></label>
    <input type="hidden" name="quill-content" id="quill-content" value="{{ .Post.Content }}">
    <div id="editor-container" class="editor"></div>
    <input type="hidden" name="id" value="{{ .Post.Id }}">
    <br>
    <button type="submit">Submit</button>
    {{ if .Post.Id }}
    <a id="delete-button" href="/posts/delete/{{ .Post.Id }}" class="button">Delete</a>
    {{ end }}
</form>
{{ end }}

{{ define "css" }}
<link href="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.snow.css" rel="stylesheet" />
<style>
    .editor {
        height: 200px;
        border: 1px solid #ccc;
        border-radius: 5px;
        padding: 10px;
        background: #fff;
    }

    #delete-button {
        background-color: var(--code);
    }

    #editor-container img {
        position: relative;
        max-width: 100%;
        cursor: move;
    }

    #editor-container img.resizable:after {
        content: '';
        position: absolute;
        right: 0;
        bottom: 0;
        width: 15px;
        height: 15px;
        background-size: 12px;
        pointer-events: none;
    }

    #editor-container img.resizable {
        cursor: se-resize;
    }
</style>
{{ end }}

{{ define "js" }}
<script src="https://cdn.jsdelivr.net/npm/quill@2.0.3/dist/quill.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const quill = new Quill('#editor-container', {
            theme: 'snow',
            modules: {
                toolbar: {
                    container: [
                        ['bold', 'italic', 'underline', 'strike'],
                        ['image']
                    ],
                    handlers: {
                        image: imageHandler
                    }
                }
            }
        });

        function imageHandler() {
            const input = document.createElement('input');
            input.setAttribute('type', 'file');
            input.setAttribute('accept', 'image/*');
            input.onchange = async () => {
                const file = input.files[0];
                const formData = new FormData();
                formData.append('image', file);

                try {
                    const response = await fetch('/post/upload-image', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();

                    const range = this.quill.getSelection();
                    this.quill.insertEmbed(range.index, 'image', data.url);
                } catch (err) {
                    console.error('Image upload failed:', err);
                }
            };
            input.click();
        }

        function makeImagesResizable() {
            const images = document.querySelectorAll('#editor-container img');
            images.forEach(img => {
                img.classList.add('resizable');
                img.addEventListener('mousedown', startResizing);
            });
        }

        let isResizing = false;
        let imgElement = null;
        let imgWidth = 0;
        let imgHeight = 0;
        let aspectRatio = 0;
        let startX = 0;
        let startY = 0;

        function startResizing(e) {
            isResizing = true;
            imgElement = e.target;
            imgWidth = imgElement.offsetWidth;
            imgHeight = imgElement.offsetHeight;
            startX = e.clientX;
            startY = e.clientY;

            e.preventDefault();

            window.addEventListener('mousemove', resizeImage);
            window.addEventListener('mouseup', stopResizing);
        }

        function resizeImage(e) {
            if (!isResizing) return;

            const dx = e.clientX - startX;
            const dy = e.clientY - startY;

            const newWidth = imgWidth + dx;
            const newHeight = imgHeight + dy;

            const proportionalHeight = newWidth / aspectRatio;

            if (newWidth > 50 && proportionalHeight > 50) {
                imgElement.style.width = `${newWidth}px`;
                imgElement.style.height = `${proportionalHeight}px`;
            }
        }

        function stopResizing() {
            isResizing = false;
            window.removeEventListener('mousemove', resizeImage);
            window.removeEventListener('mouseup', stopResizing);
        }

        quill.on('editor-change', makeImagesResizable);

        quill.root.innerHTML = document.getElementById('quill-content').value

        document.getElementById('add-post-form').addEventListener('submit', function (event) {
            var quillContent = document.getElementById('quill-content');
            quillContent.value = quill.root.innerHTML;
        });
    });
</script>

{{ end }}